<!doctype html>
<!--
  Copyright Â© 2025 Martin Fish
  All Rights Reserved

  This software and associated documentation files are proprietary and confidential.
  Unauthorized copying, distribution, modification, or use of this software,
  via any medium, is strictly prohibited without express written permission.
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#4c1d95" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />
    <title>ClassSeats â€” New UI</title>
    <script type="module" crossorigin src="/assets/index-CNcvRKtK.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-D4R3PKX2.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      ;(() => {
        const STORAGE_PREFIXES = ['classseats_', 'classseats.', 'newui_']
        const STORAGE_KEYS = new Set(['attendance:lastDate'])
        const KNOWN_INDEXED_DB_NAMES = ['classseats_auth', 'classseats-cache']

        function canShowRecovery() {
          return document.visibilityState === 'visible'
        }

        function clearClassSeatsLocalStorage() {
          try {
            const toDelete = []
            for (let i = 0; i < window.localStorage.length; i += 1) {
              const key = window.localStorage.key(i)
              if (!key) continue
              const matchesPrefix = STORAGE_PREFIXES.some((prefix) => key.startsWith(prefix))
              if (matchesPrefix || STORAGE_KEYS.has(key)) {
                toDelete.push(key)
              }
            }
            for (const key of toDelete) {
              window.localStorage.removeItem(key)
            }
          } catch {
            // Ignore storage access errors in degraded environments.
          }
        }

        function clearSessionStorage() {
          try {
            window.sessionStorage.clear()
          } catch {
            // Ignore storage access errors in degraded environments.
          }
        }

        function deleteKnownDatabases() {
          if (!('indexedDB' in window)) return Promise.resolve()
          return Promise.all(
            KNOWN_INDEXED_DB_NAMES.map(
              (name) =>
                new Promise((resolve) => {
                  try {
                    const req = window.indexedDB.deleteDatabase(name)
                    req.onsuccess = () => resolve()
                    req.onerror = () => resolve()
                    req.onblocked = () => resolve()
                  } catch {
                    resolve()
                  }
                })
            )
          )
        }

        function hardReload() {
          window.location.reload()
        }

        async function unregisterServiceWorkers() {
          if (!('serviceWorker' in navigator)) return
          try {
            const regs = await navigator.serviceWorker.getRegistrations()
            await Promise.all(regs.map((reg) => reg.unregister()))
          } catch {
            // Ignore service worker errors in recovery mode.
          }
        }

        async function clearCacheStorage() {
          if (!('caches' in window)) return
          try {
            const keys = await caches.keys()
            await Promise.all(keys.map((key) => caches.delete(key)))
          } catch {
            // Ignore cache errors in recovery mode.
          }
        }

        async function repairAppCache() {
          await unregisterServiceWorkers()
          await clearCacheStorage()
          hardReload()
        }

        async function clearLocalClassSeatsData() {
          const confirmed = window.confirm(
            'Restart will clear local ClassSeats data on this device, then reload the app. Continue?'
          )
          if (!confirmed) return
          clearClassSeatsLocalStorage()
          clearSessionStorage()
          await deleteKnownDatabases()
          await repairAppCache()
        }

        function hideOverlay() {
          const overlay = document.getElementById('cs-boot-recovery')
          if (!overlay) return
          overlay.style.display = 'none'
        }

        function showOverlay() {
          if (!canShowRecovery()) return
          if (window.__cs_boot_mounted) return
          const overlay = document.getElementById('cs-boot-recovery')
          if (!overlay) return
          overlay.style.display = 'flex'
        }

        const overlay = document.createElement('div')
        overlay.id = 'cs-boot-recovery'
        overlay.style.display = 'none'
        overlay.style.position = 'fixed'
        overlay.style.inset = '0'
        overlay.style.zIndex = '9999'
        overlay.style.background = '#f8fafc'
        overlay.style.color = '#0f172a'
        overlay.style.alignItems = 'center'
        overlay.style.justifyContent = 'center'
        overlay.style.padding = '24px'
        overlay.innerHTML =
          '<div style="width:100%;max-width:560px;background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(15,23,42,.08)">' +
          '<h1 style="margin:0 0 8px;font-size:1.1rem">Oops - the most recent update did not install properly. This happens sometimes. Sorry! ðŸ˜¥</h1>' +
          '<p style="margin:0 0 12px;line-height:1.45">Try the buttons below, in order, to try to get things running again.</p>' +
          '<p style="margin:0 0 16px;line-height:1.45;color:#334155">If that does not work, delete the shortcut on your home screen, go to mobile.classseats.app, and add a new shortcut to your home screen.</p>' +
          '<div style="display:flex;flex-direction:column;gap:8px">' +
          '<button id="cs-recovery-reload" type="button" style="border:1px solid #cbd5e1;border-radius:10px;padding:10px 14px;background:#fff;color:#0f172a;font-weight:600;cursor:pointer">Reload</button>' +
          '<button id="cs-recovery-repair" type="button" style="border:1px solid #cbd5e1;border-radius:10px;padding:10px 14px;background:#fff;color:#0f172a;font-weight:600;cursor:pointer">Refresh</button>' +
          '<button id="cs-recovery-restart" type="button" style="border:1px solid #cbd5e1;border-radius:10px;padding:10px 14px;background:#fff;color:#0f172a;font-weight:600;cursor:pointer">Restart</button>' +
          '</div>' +
          '</div>'
        document.body.appendChild(overlay)

        document.getElementById('cs-recovery-reload')?.addEventListener('click', hardReload)
        document.getElementById('cs-recovery-repair')?.addEventListener('click', () => {
          repairAppCache()
        })
        document.getElementById('cs-recovery-restart')?.addEventListener('click', () => {
          clearLocalClassSeatsData()
        })

        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection
        const effectiveType = connection && typeof connection.effectiveType === 'string' ? connection.effectiveType : ''
        const bootTimeoutMs = effectiveType === '2g' || effectiveType === 'slow-2g' ? 10_000 : 8_000

        window.addEventListener('classseats:boot-mounted', hideOverlay, { once: true })
        document.addEventListener('visibilitychange', () => {
          if (window.__cs_boot_mounted) hideOverlay()
        })

        window.setTimeout(() => {
          if (window.__cs_boot_mounted) return
          showOverlay()
        }, bootTimeoutMs)
      })()
    </script>
  </body>
</html>
